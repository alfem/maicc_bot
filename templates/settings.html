<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n - Bot Compa√±ero</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link, .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            transition: background 0.3s;
        }

        .nav-link:hover, .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .settings-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .help-text {
            display: block;
            color: #666;
            font-size: 13px;
            margin-top: 5px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        select {
            cursor: pointer;
            background-color: white;
        }

        input[type="number"] {
            width: 150px;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }

        .textarea-large {
            min-height: 200px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        .inline-group {
            display: flex;
            gap: 20px;
            align-items: flex-end;
        }

        .inline-group .form-group {
            flex: 1;
        }

        .submit-btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .submit-btn:hover {
            background: #5568d3;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            color: #856404;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .reload-btn {
            background: #28a745;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-left: 10px;
        }

        .reload-btn:hover {
            background: #218838;
        }

        .reload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            color: #0c5460;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>‚öôÔ∏è Configuraci√≥n del Bot</h1>
            <div class="nav-links">
                <a href="/" class="nav-link">Usuarios</a>
                <a href="/logout" class="logout-btn">Cerrar sesi√≥n</a>
            </div>
        </div>
    </div>

    <div class="container">
        {% if success %}
        <div class="alert alert-success">
            ‚úÖ Configuraci√≥n guardada exitosamente.
            {% if reload_pending %}
            <div class="info-box" style="margin-top: 10px;">
                <strong>üîÑ Recarga autom√°tica programada</strong>
                El bot aplicar√° los cambios autom√°ticamente en 30 segundos o menos.
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if error %}
        <div class="alert alert-error">
            ‚ùå Error al guardar la configuraci√≥n: {{ error }}
        </div>
        {% endif %}

        <form method="POST" class="settings-form">
            <!-- LLM Configuration -->
            <div class="form-section">
                <h2>ü§ñ Configuraci√≥n del LLM</h2>

                <div class="form-group">
                    <label for="model">Modelo</label>
                    <select id="model" name="model" required>
                        <optgroup label="Gemini 2.5 (Recomendado)">
                            <option value="gemini-2.5-pro" {% if config.llm.model == 'gemini-2.5-pro' %}selected{% endif %}>Gemini 2.5 Pro (M√°s potente)</option>
                            <option value="gemini-2.5-flash" {% if config.llm.model == 'gemini-2.5-flash' %}selected{% endif %}>Gemini 2.5 Flash (Equilibrado)</option>
                            <option value="gemini-2.5-flash-lite" {% if config.llm.model == 'gemini-2.5-flash-lite' %}selected{% endif %}>Gemini 2.5 Flash-Lite (R√°pido y econ√≥mico)</option>
                        </optgroup>
                        <optgroup label="Gemini 2.0">
                            <option value="gemini-2.0-flash" {% if config.llm.model == 'gemini-2.0-flash' %}selected{% endif %}>Gemini 2.0 Flash</option>
                            <option value="gemini-2.0-flash-lite" {% if config.llm.model == 'gemini-2.0-flash-lite' %}selected{% endif %}>Gemini 2.0 Flash-Lite</option>
                        </optgroup>
                        <optgroup label="Experimentales">
                            <option value="gemini-2.0-flash-exp" {% if config.llm.model == 'gemini-2.0-flash-exp' %}selected{% endif %}>Gemini 2.0 Flash Experimental</option>
                        </optgroup>
                    </select>
                    <span class="help-text">Selecciona el modelo de IA que usar√° el bot. Los modelos 2.5 son m√°s recientes y potentes.</span>
                </div>

                <div class="form-group">
                    <label for="system_prompt">System Prompt</label>
                    <textarea id="system_prompt" name="system_prompt" class="textarea-large" required>{{ config.llm.system_prompt }}</textarea>
                    <span class="help-text">Define la personalidad y comportamiento del asistente</span>
                </div>

                <div class="inline-group">
                    <div class="form-group">
                        <label for="temperature">Temperatura</label>
                        <input type="number" id="temperature" name="temperature"
                               value="{{ config.llm.temperature }}"
                               min="0" max="2" step="0.1" required>
                        <span class="help-text">Creatividad (0.0 - 2.0)</span>
                    </div>

                    <div class="form-group">
                        <label for="max_tokens">Max Tokens</label>
                        <input type="number" id="max_tokens" name="max_tokens"
                               value="{{ config.llm.max_tokens }}"
                               min="256" max="32768" step="256" required>
                        <span class="help-text">Longitud m√°xima de respuesta</span>
                    </div>
                </div>
            </div>

            <!-- Telegram Configuration -->
            <div class="form-section">
                <h2>üí¨ Configuraci√≥n de Telegram</h2>

                <div class="form-group">
                    <label for="message_grouping_delay">Tiempo de espera para agrupar mensajes (segundos)</label>
                    <input type="number" id="message_grouping_delay" name="message_grouping_delay"
                           value="{{ config.telegram.message_grouping_delay }}"
                           min="0" max="30" step="0.5" required>
                    <span class="help-text">Tiempo que espera el bot antes de responder, permitiendo que el usuario env√≠e m√∫ltiples mensajes consecutivos. Si es 0, el bot responde de inmediato.</span>
                </div>
            </div>

            <!-- Proactive Messaging -->
            <div class="form-section">
                <h2>üí¨ Mensajes Proactivos</h2>

                <div class="form-group">
                    <label for="inactivity_minutes">Minutos de inactividad</label>
                    <input type="number" id="inactivity_minutes" name="inactivity_minutes"
                           value="{{ config.proactive.inactivity_minutes }}"
                           min="5" max="1440" required>
                    <span class="help-text">Tiempo antes de enviar un mensaje proactivo</span>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="quiet_hours_enabled" name="quiet_hours_enabled"
                               {% if config.proactive.quiet_hours.enabled %}checked{% endif %}>
                        <label for="quiet_hours_enabled">Habilitar horario de no molestar</label>
                    </div>
                </div>

                <div class="inline-group">
                    <div class="form-group">
                        <label for="quiet_hours_start">Inicio (hora de silencio)</label>
                        <input type="time" id="quiet_hours_start" name="quiet_hours_start"
                               value="{{ config.proactive.quiet_hours.start }}">
                    </div>

                    <div class="form-group">
                        <label for="quiet_hours_end">Fin (hora de silencio)</label>
                        <input type="time" id="quiet_hours_end" name="quiet_hours_end"
                               value="{{ config.proactive.quiet_hours.end }}">
                    </div>
                </div>
            </div>

            <!-- RSS Feeds -->
            <div class="form-section">
                <h2>üì∞ Fuentes RSS</h2>

                <div class="form-group">
                    <label for="rss_feeds">URLs de feeds RSS (una por l√≠nea)</label>
                    <textarea id="rss_feeds" name="rss_feeds">{% for feed in config.news.rss_feeds %}{{ feed }}
{% endfor %}</textarea>
                    <span class="help-text">El bot usar√° estas noticias para iniciar conversaciones</span>
                </div>
            </div>

            <!-- TTS Configuration -->
            <div class="form-section">
                <h2>üé§ Generaci√≥n de Voz (TTS)</h2>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="tts_enabled" name="tts_enabled"
                               {% if config.tts.enabled %}checked{% endif %}>
                        <label for="tts_enabled">Habilitar generaci√≥n de voz</label>
                    </div>
                    <span class="help-text">Permite que el bot env√≠e algunos mensajes como audio de voz</span>
                </div>

                <div class="form-group">
                    <label for="tts_provider">Proveedor de TTS</label>
                    <select id="tts_provider" name="tts_provider" onchange="toggleTTSProvider()">
                        <option value="gemini" {% if config.tts.provider == 'gemini' %}selected{% endif %}>Google Gemini TTS (Incluido)</option>
                        <option value="elevenlabs" {% if config.tts.provider == 'elevenlabs' %}selected{% endif %}>Eleven Labs (Mayor calidad)</option>
                    </select>
                    <span class="help-text">Selecciona el servicio que generar√° las voces</span>
                </div>

                <div class="inline-group">
                    <div class="form-group">
                        <label for="tts_frequency">Frecuencia de mensajes de voz (%)</label>
                        <input type="number" id="tts_frequency" name="tts_frequency"
                               value="{{ config.tts.frequency_percent }}"
                               min="0" max="100" step="5">
                        <span class="help-text">Porcentaje de mensajes que se enviar√°n como voz (0 = nunca, 100 = siempre)</span>
                    </div>

                    <div class="form-group">
                        <label for="tts_audio_dir">Directorio de audio</label>
                        <input type="text" id="tts_audio_dir" name="tts_audio_dir"
                               value="{{ config.tts.audio_dir }}">
                        <span class="help-text">Carpeta donde guardar audios generados</span>
                    </div>
                </div>

                <!-- Gemini TTS Settings -->
                <div id="gemini_settings" class="provider-settings">
                    <h3 style="color: #667eea; margin-top: 20px; margin-bottom: 15px;">‚öôÔ∏è Configuraci√≥n de Google Gemini TTS</h3>

                    <div class="form-group">
                        <label for="gemini_api_key">API Key de Google Gemini (opcional)</label>
                        <input type="password" id="gemini_api_key" name="gemini_api_key"
                               value="{{ config.tts.gemini.api_key }}"
                               placeholder="Usa la API key del LLM si est√° vac√≠o">
                        <span class="help-text">Deja vac√≠o para usar la API key del LLM configurada arriba</span>
                    </div>

                    <div class="form-group">
                        <label for="gemini_model">Modelo TTS de Gemini</label>
                        <select id="gemini_model" name="gemini_model">
                            <option value="gemini-2.5-flash-preview-tts" {% if config.tts.gemini.model == 'gemini-2.5-flash-preview-tts' %}selected{% endif %}>Gemini 2.5 Flash TTS (Recomendado)</option>
                            <option value="gemini-2.0-flash-tts" {% if config.tts.gemini.model == 'gemini-2.0-flash-tts' %}selected{% endif %}>Gemini 2.0 Flash TTS</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="gemini_speaker">Voz (Speaker)</label>
                        <select id="gemini_speaker" name="gemini_speaker">
                            <option value="Leda" {% if config.tts.gemini.speaker == 'Leda' %}selected{% endif %}>Leda - Juvenil</option>
                            <option value="Puck" {% if config.tts.gemini.speaker == 'Puck' %}selected{% endif %}>Puck - Optimista</option>
                            <option value="Charon" {% if config.tts.gemini.speaker == 'Charon' %}selected{% endif %}>Charon - Informativa</option>
                            <option value="Kore" {% if config.tts.gemini.speaker == 'Kore' %}selected{% endif %}>Kore - Firme</option>
                            <option value="Fenrir" {% if config.tts.gemini.speaker == 'Fenrir' %}selected{% endif %}>Fenrir - Excitable</option>
                            <option value="Aoede" {% if config.tts.gemini.speaker == 'Aoede' %}selected{% endif %}>Aoede - Breezy</option>
                            <option value="Sulafat" {% if config.tts.gemini.speaker == 'Sulafat' %}selected{% endif %}>Sulafat - Expresiva</option>
                            <option value="Zephyr" {% if config.tts.gemini.speaker == 'Zephyr' %}selected{% endif %}>Zephyr - Brillante</option>
                            <option value="Orus" {% if config.tts.gemini.speaker == 'Orus' %}selected{% endif %}>Orus - Firme</option>
                            <option value="Callirrhoe" {% if config.tts.gemini.speaker == 'Callirrhoe' %}selected{% endif %}>Callirrhoe - Tranquila</option>
                        </select>
                        <span class="help-text">Selecciona la voz de Gemini (30+ voces disponibles)</span>
                    </div>

                    <div class="form-group">
                        <label for="gemini_preamble">Pre√°mbulo de Gemini</label>
                        <input type="text" id="gemini_preamble" name="gemini_preamble"
                               value="{{ config.tts.gemini.preamble }}"
                               placeholder="Habla de forma natural y expresiva:">
                        <span class="help-text">Texto gu√≠a para el estilo de voz</span>
                    </div>

                    <div class="form-group">
                        <label for="gemini_temperature">Temperatura de Gemini</label>
                        <input type="number" id="gemini_temperature" name="gemini_temperature"
                               value="{{ config.tts.gemini.temperature }}"
                               min="0" max="1" step="0.1" style="width: 150px;">
                        <span class="help-text">Control de variaci√≥n de voz (0.0-1.0)</span>
                    </div>
                </div>

                <!-- Eleven Labs TTS Settings -->
                <div id="elevenlabs_settings" class="provider-settings" style="display: none;">
                    <h3 style="color: #667eea; margin-top: 20px; margin-bottom: 15px;">‚öôÔ∏è Configuraci√≥n de Eleven Labs TTS</h3>

                    <div class="form-group">
                        <label for="elevenlabs_api_key">API Key de Eleven Labs *</label>
                        <input type="password" id="elevenlabs_api_key" name="elevenlabs_api_key"
                               value="{{ config.tts.elevenlabs.api_key }}"
                               placeholder="sk-...">
                        <span class="help-text">Requerida para usar Eleven Labs. Obt√©n tu key en: elevenlabs.io/app/settings</span>
                    </div>

                    <div class="form-group">
                        <label for="elevenlabs_voice_id">Voice ID</label>
                        <input type="text" id="elevenlabs_voice_id" name="elevenlabs_voice_id"
                               value="{{ config.tts.elevenlabs.voice_id }}"
                               placeholder="21m00Tcm4TlvDq8ikWAM">
                        <span class="help-text">ID de la voz (por defecto: Rachel). Explora voces en elevenlabs.io/voice-library</span>
                    </div>

                    <div class="form-group">
                        <label for="elevenlabs_model_id">Modelo de Eleven Labs</label>
                        <select id="elevenlabs_model_id" name="elevenlabs_model_id">
                            <option value="eleven_multilingual_v2" {% if config.tts.elevenlabs.model_id == 'eleven_multilingual_v2' %}selected{% endif %}>Eleven Multilingual v2 (Soporta espa√±ol)</option>
                            <option value="eleven_monolingual_v1" {% if config.tts.elevenlabs.model_id == 'eleven_monolingual_v1' %}selected{% endif %}>Eleven Monolingual v1 (Solo ingl√©s)</option>
                            <option value="eleven_turbo_v2" {% if config.tts.elevenlabs.model_id == 'eleven_turbo_v2' %}selected{% endif %}>Eleven Turbo v2 (R√°pido)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="elevenlabs_preamble">Pre√°mbulo de Eleven Labs</label>
                        <input type="text" id="elevenlabs_preamble" name="elevenlabs_preamble"
                               value="{{ config.tts.elevenlabs.preamble }}"
                               placeholder="Texto o etiquetas a anteponer...">
                        <span class="help-text">Texto/etiquetas que se a√±adir√°n antes del contenido (ej: etiquetas SSML, instrucciones)</span>
                    </div>

                    <div class="inline-group">
                        <div class="form-group">
                            <label for="elevenlabs_stability">Stability</label>
                            <input type="number" id="elevenlabs_stability" name="elevenlabs_stability"
                                   value="{{ config.tts.elevenlabs.stability }}"
                                   min="0" max="1" step="0.05">
                            <span class="help-text">Consistencia de voz (0.0-1.0)</span>
                        </div>

                        <div class="form-group">
                            <label for="elevenlabs_similarity_boost">Similarity Boost</label>
                            <input type="number" id="elevenlabs_similarity_boost" name="elevenlabs_similarity_boost"
                                   value="{{ config.tts.elevenlabs.similarity_boost }}"
                                   min="0" max="1" step="0.05">
                            <span class="help-text">Similitud con voz original (0.0-1.0)</span>
                        </div>
                    </div>

                    <div class="inline-group">
                        <div class="form-group">
                            <label for="elevenlabs_style">Style</label>
                            <input type="number" id="elevenlabs_style" name="elevenlabs_style"
                                   value="{{ config.tts.elevenlabs.style }}"
                                   min="0" max="1" step="0.05">
                            <span class="help-text">Expresividad (0.0-1.0, solo v2)</span>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="elevenlabs_speaker_boost" name="elevenlabs_speaker_boost"
                                       {% if config.tts.elevenlabs.use_speaker_boost %}checked{% endif %}>
                                <label for="elevenlabs_speaker_boost">Speaker Boost</label>
                            </div>
                            <span class="help-text">Mejora similitud con el speaker</span>
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <strong>‚ÑπÔ∏è Sobre la generaci√≥n de voz</strong>
                    El bot decidir√° aleatoriamente si enviar cada mensaje como voz seg√∫n el porcentaje configurado.
                    Si la generaci√≥n de audio falla, el mensaje se enviar√° autom√°ticamente como texto.
                </div>
            </div>

            <!-- Admin Password -->
            <div class="form-section">
                <h2>üîê Contrase√±a de Administrador</h2>

                <div class="form-group">
                    <label for="admin_password">Nueva contrase√±a (dejar vac√≠o para no cambiar)</label>
                    <input type="password" id="admin_password" name="admin_password"
                           placeholder="Nueva contrase√±a">
                    <span class="help-text">Contrase√±a para acceder a esta interfaz web</span>
                </div>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Advertencia:</strong>
                    Si cambias la contrase√±a, tendr√°s que volver a iniciar sesi√≥n con la nueva contrase√±a.
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <div class="button-group">
                    <button type="submit" class="submit-btn">üíæ Guardar Configuraci√≥n</button>
                    <button type="button" class="reload-btn" onclick="reloadConfig()" id="reloadBtn">
                        üîÑ Recargar Ahora
                    </button>
                </div>
                <div class="info-box" style="margin-top: 15px; max-width: 600px; margin-left: auto; margin-right: auto;">
                    <strong>‚ÑπÔ∏è Sobre la recarga</strong>
                    Los cambios se aplican autom√°ticamente cada 30 segundos. Usa "Recargar Ahora" para forzar una recarga inmediata sin esperar.
                </div>
            </div>
        </form>
    </div>

    <script>
        // Funci√≥n para mostrar/ocultar configuraci√≥n seg√∫n proveedor TTS seleccionado
        function toggleTTSProvider() {
            const provider = document.getElementById('tts_provider').value;
            const geminiSettings = document.getElementById('gemini_settings');
            const elevenlabsSettings = document.getElementById('elevenlabs_settings');

            if (provider === 'gemini') {
                geminiSettings.style.display = 'block';
                elevenlabsSettings.style.display = 'none';
            } else if (provider === 'elevenlabs') {
                geminiSettings.style.display = 'none';
                elevenlabsSettings.style.display = 'block';
            }
        }

        // Ejecutar al cargar la p√°gina para mostrar la configuraci√≥n correcta
        document.addEventListener('DOMContentLoaded', function() {
            toggleTTSProvider();
        });

        async function reloadConfig() {
            const btn = document.getElementById('reloadBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Recargando...';

            try {
                const response = await fetch('/reload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                alert('‚ùå Error al solicitar recarga: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Recargar Ahora';
            }
        }
    </script>
</body>
</html>
